<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Thống kê Tổng hợp Dữ liệu QLKT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #0f172a; --bg-soft: #111827; --card: #020617;
      --accent: #38bdf8; --text: #e5e7eb; --muted: #9ca3af; --border: #1f2937;
      --danger: #f97373; --success: #4ade80; --warning: #facc15;
      --radius-lg: 16px; --radius-md: 10px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif; background: radial-gradient(circle at top left, #1d283a, #020617 60%); color: var(--text); padding: 20px; }
    .dashboard { max-width: 1280px; margin: 0 auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; gap: 16px; flex-wrap: wrap; }
    .header-title h1 { font-size: 22px; font-weight: 600; letter-spacing: 0.03em; display: flex; align-items: center; gap: 8px; }
    .header-title span { font-size: 13px; color: var(--muted); margin-top: 4px; display: block; }
    .pill { background: linear-gradient(90deg, rgba(56, 189, 248, 0.2), rgba(129, 140, 248, 0.2)); border-radius: 999px; padding: 4px 10px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--accent); border: 1px solid rgba(56, 189, 248, 0.3); }
    .filters { display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 12px; }
    .filters-row { display: flex; gap: 10px; flex-wrap: wrap; }
    .filter-group { display: flex; flex-direction: column; gap: 4px; font-size: 11px; color: var(--muted); }
    .filter-wrapper { position: relative; display: inline-block; }
    .filter-select { background: var(--bg-soft); border-radius: 999px; border: 1px solid var(--border); color: var(--text); padding: 6px 26px 6px 10px; font-size: 13px; outline: none; min-width: 160px; appearance: none; }
    .filter-wrapper i { position: absolute; right: 9px; top: 50%; transform: translateY(-50%); font-size: 11px; color: var(--muted); pointer-events: none; }
    .grid { display: grid; grid-template-columns: 2.1fr 1.2fr; gap: 16px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    .card { background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.05), var(--card)); border-radius: var(--radius-lg); border: 1px solid rgba(148, 163, 184, 0.15); box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9); padding: 14px 16px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 6px; }
    .card-title { font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
    .card-title i { color: var(--accent); font-size: 14px; }
    .card-subtitle { font-size: 12px; color: var(--muted); }
    .kpi-grid { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 10px; margin-top: 4px; }
    @media (max-width: 900px) { .kpi-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    .kpi-card { background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.9)); border-radius: var(--radius-md); border: 1px solid rgba(148, 163, 184, 0.2); padding: 10px; display: flex; flex-direction: column; gap: 4px; }
    .kpi-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; }
    .kpi-value-row { display: flex; align-items: baseline; justify-content: space-between; gap: 6px; }
    .kpi-value { font-size: 22px; font-weight: 600; }
    .kpi-chip { font-size: 11px; padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(148, 163, 184, 0.3); display: inline-flex; align-items: center; gap: 4px; color: var(--muted); background: rgba(15, 23, 42, 0.9); }
    .kpi-chip.positive { border-color: rgba(74, 222, 128, 0.5); color: var(--success); background: rgba(22, 163, 74, 0.08); }
    .kpi-chip.warning { border-color: rgba(250, 204, 21, 0.5); color: var(--warning); background: rgba(250, 204, 21, 0.08); }
    .kpi-chip.negative { border-color: rgba(248, 113, 113, 0.5); color: var(--danger); background: rgba(248, 113, 113, 0.08); }
    .table-wrapper { margin-top: 8px; border-radius: var(--radius-md); border: 1px solid var(--border); overflow: hidden; }
    .table-header-row, .table-row { display: grid; grid-template-columns: var(--cols); font-size: 12px; padding: 6px 10px; align-items: center; gap: 8px; }
    .table-header-row { background: var(--bg-soft); font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); }
    .table-body { max-height: 260px; overflow-y: auto; }
    .mini-tag { font-size: 10px; color: var(--muted); padding: 2px 6px; border-radius: 999px; background: rgba(15, 23, 42, 0.9); border: 1px dashed rgba(148, 163, 184, 0.4); }
    .loading { font-size: 13px; color: var(--muted); margin-top: 6px; }
    .error { color: var(--danger); font-size: 12px; margin-top: 6px; }
    .toggle { display: inline-flex; align-items: center; gap: 8px; font-size: 12px; color: var(--muted); }
    .toggle input { width: 16px; height: 16px; }
    .card-footer { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:10px; color:var(--muted); font-size:12px; }
    .breakdown-area { margin-top: 12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .small { font-size:12px; color:var(--muted); }
  </style>
</head>
<body>
  <div class="dashboard">
    <div class="header">
      <div class="header-title">
        <div>
          <h1><i class="fa-solid fa-layer-group"></i> Thống kê tổng hợp Dữ liệu QLKT</h1>
          <span>Thống kê dữ liệu các dự án, văn bản trình ký, nghiệm thu nội bộ.</span>
        </div>
      </div>
      <span class="pill">Copyright PQLKT 2025</span>
    </div>

    <div class="filters">
      <div class="filters-row">
        <div class="filter-group">
          <span>Loại dữ liệu</span>
          <div class="filter-wrapper">
            <select id="dataTypeFilter" class="filter-select">
              <option value="QLKT">QLKT</option>
              <option value="TRINH_VB">Trình VB</option>
              <option value="NGHIEM_THU_NB">Nghiệm thu NB</option>
              <option value="TONG_CONG">Tổng cộng</option>
            </select>
            <i class="fa-solid fa-chevron-down"></i>
          </div>
        </div>
        <div class="filter-group">
          <span>Năm</span>
          <div class="filter-wrapper">
            <select id="yearFilter" class="filter-select">
              <option value="all">Tất cả</option>
            </select>
            <i class="fa-solid fa-chevron-down"></i>
          </div>
        </div>
        <div class="filter-group">
          <span>Tháng</span>
          <div class="filter-wrapper">
            <select id="monthFilter" class="filter-select">
              <option value="all">Cả năm</option>
              <option value="1">01</option><option value="2">02</option>
              <option value="3">03</option><option value="4">04</option>
              <option value="5">05</option><option value="6">06</option>
              <option value="7">07</option><option value="8">08</option>
              <option value="9">09</option><option value="10">10</option>
              <option value="11">11</option><option value="12">12</option>
            </select>
            <i class="fa-solid fa-chevron-down"></i>
          </div>
        </div>
      </div>
      <div id="dynamicFilters" class="filters-row"></div>
    </div>

    <div class="grid">
      <div>
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title"><i class="fa-solid fa-gauge-high"></i> Chỉ số tổng hợp</div>
              <div class="card-subtitle">KPI và biểu đồ theo loại dữ liệu và bộ lọc cột.</div>
            </div>
            <label class="toggle" title="Khi bật: biểu đồ cột hiển thị tổng cộng theo tháng cho năm đang lọc">
              <input type="checkbox" id="totalMonthlyToggle" />
              <span>Tổng cộng theo tháng</span>
            </label>
          </div>

          <div class="kpi-grid" id="kpiGrid"></div>
          <div class="loading" id="loadingKpi">Đang tải dữ liệu từ Google Sheets...</div>
          <div class="error" id="errorBox" style="display:none;"></div>

          <div style="margin-top: 10px;">
            <div class="card-header">
              <div class="card-title"><i class="fa-solid fa-chart-column"></i> Biểu đồ theo tháng/năm</div>
              <span class="mini-tag">Số lượng bản ghi theo tháng trong năm đang lọc</span>
            </div>
            <canvas id="monthChart" height="160"></canvas>
            <div class="card-footer">
              <div>Đơn vị: số bản ghi / tháng</div>
            </div>
          </div>

          <div class="breakdown-area">
            <div class="filter-group" style="min-width:120px;">
              <span>Phân tích theo trường</span>
              <div class="filter-wrapper">
                <select id="breakdownField" class="filter-select">
                  <option value="none">Chọn trường hiển thị biểu đồ pie </option>
                </select>
                <i class="fa-solid fa-chevron-down"></i>
              </div>
            </div>
            <div class="small"></div>
          </div>

          <div style="margin-top:12px;">
            <canvas id="breakdownPie" height="110"></canvas>
          </div>
        </div>
      </div>

      <div>
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title"><i class="fa-solid fa-chart-pie"></i> Phân bố theo loại dữ liệu</div>
              <div class="card-subtitle">Áp dụng đầy đủ bộ lọc năm, tháng và cột động</div>
            </div>
          </div>
          <canvas id="pieChart" height="110"></canvas>
          <div class="card-footer">
            <div id="pieFooterText" class="mini-tag">QLKT vs Trình VB vs Nghiệm thu NB</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:20px;">
      <div class="card-header">
        <div>
          <div class="card-title"><i class="fa-solid fa-table-list"></i> Danh sách theo bộ lọc</div>
          <div class="card-subtitle">Hiển thị đúng cột theo từng loại dữ liệu hoặc tổng hợp theo năm.</div>
        </div>
      </div>
      <div class="table-wrapper">
        <div id="tableHeader" class="table-header-row" style="--cols: 2fr 1fr 1fr 1fr 1fr;"></div>
        <div class="table-body" id="tableBody"></div>
      </div>

      <div id="cardFooter" class="card-footer" style="display:none;">
        <div id="footerText"></div>
        <div class="mini-tag">Nguồn: P.QLKT</div>
      </div>
    </div>
  </div>

<script>
  // ====== CẤU HÌNH GOOGLE SHEETS ======
  const SPREADSHEET_ID = "12VZMuTxWo1o44zYpX2llB2BSGbEgn4nQldCKRUbdmeQ";
  const SHEET_NAME_DUAN      = "QLKT Data Sort";
  const SHEET_NAME_TRINHKY   = "QLKT Trình ký Sort";
  const SHEET_NAME_NGHIEMTHU = "QLKT Nghiệm thu nội bộ Sort";

  // ====== DOM ======
  const dataTypeFilter = document.getElementById("dataTypeFilter");
  const yearFilter   = document.getElementById("yearFilter");
  const monthFilter  = document.getElementById("monthFilter");
  const dynamicFilters = document.getElementById("dynamicFilters");
  const kpiGrid      = document.getElementById("kpiGrid");
  const tableHeader  = document.getElementById("tableHeader");
  const tableBody    = document.getElementById("tableBody");
  const loadingKpi   = document.getElementById("loadingKpi");
  const errorBox     = document.getElementById("errorBox");
  const totalMonthlyToggle = document.getElementById("totalMonthlyToggle");
  const cardFooter = document.getElementById("cardFooter");
  const footerText = document.getElementById("footerText");
  const breakdownField = document.getElementById("breakdownField");

  let dataQLKT = [], dataTRINH_VB = [], dataNGHIEM_THU_NB = [];
  let chart, pie, breakdownChart;

  // ====== SCHEMA ======
  const TYPE_SCHEMAS = {
    QLKT: {
      label: "QLKT",
      sheet: "DUAN",
      filters: [
        { key: "Ngày", label: "Ngày" },
        { key: "Chuyên viên phụ trách", label: "Chuyên viên phụ trách" },
        { key: "Đơn vị thực hiện", label: "Đơn vị thực hiện" },
        { key: "Tên dự án", label: "Tên dự án" },
        { key: "Chủ nhiệm", label: "Chủ nhiệm" },
        { key: "Mục đích trình", label: "Mục đích trình" },
        { key: "ID", label: "ID" },
        { key: "Year", label: "Year" }
      ],
      tableCols: [
        { key: "Ngày", label: "Ngày", width: "1.2fr" },
        { key: "Chuyên viên phụ trách", label: "Chuyên viên", width: "1.2fr" },
        { key: "Đơn vị thực hiện", label: "Đơn vị thực hiện", width: "1.2fr" },
        { key: "Tên dự án", label: "Tên dự án", width: "2fr" },
        { key: "Chủ nhiệm", label: "Chủ nhiệm", width: "1fr" },
        { key: "Mục đích trình", label: "Mục đích trình", width: "1.4fr" },
        { key: "ID", label: "ID", width: "0.8fr" },
        { key: "Year", label: "Year", width: "0.8fr" }
      ]
    },
    TRINH_VB: {
      label: "Trình VB",
      sheet: "TRINH_VB",
      filters: [
        { key: "Ngày", label: "Ngày" },
        { key: "Lãnh đạo ký", label: "Lãnh đạo ký" },
        { key: "Về việc", label: "Về việc" },
        { key: "Ý kiến chỉ đạo", label: "Ý kiến chỉ đạo" },
        { key: "Tóm tắt nội dung và kiến nghị giải quyết", label: "Tóm tắt & Kiến nghị" },
        { key: "Cơ sở ban hành văn bản", label: "Cơ sở ban hành" },
        { key: "Nhân viên soạn thảo văn bản", label: "NV soạn thảo" },
        { key: "ID", label: "ID" },
        { key: "Year", label: "Year" }
      ],
      tableCols: [
        { key: "Ngày", label: "Ngày", width: "1.2fr" },
        { key: "Lãnh đạo ký", label: "Lãnh đạo ký", width: "1.2fr" },
        { key: "Về việc", label: "Về việc", width: "1.6fr" },
        { key: "Ý kiến chỉ đạo", label: "Ý kiến chỉ đạo", width: "1.6fr" },
        { key: "Tóm tắt nội dung và kiến nghị giải quyết", label: "Tóm tắt & Kiến nghị", width: "2fr" },
        { key: "Cơ sở ban hành văn bản", label: "Cơ sở ban hành", width: "1.4fr" },
        { key: "Nhân viên soạn thảo văn bản", label: "NV soạn thảo", width: "1.2fr" },
        { key: "ID", label: "ID", width: "0.8fr" },
        { key: "Year", label: "Year", width: "0.8fr" }
      ]
    },
    NGHIEM_THU_NB: {
      label: "Nghiệm thu NB",
      sheet: "NGHIEM_THU_NB",
      filters: [
        { key: "Ngày", label: "Ngày" },
        { key: "Đơn vị thực hiện", label: "Đơn vị thực hiện" },
        { key: "Số Hợp đồng", label: "Số Hợp đồng" },
        { key: "Tên Hợp đồng", label: "Tên Hợp đồng" },
        { key: "Tình hình thực hiện", label: "Tình hình thực hiện" },
        { key: "Đánh giá tỉ lệ hoàn thành công việc", label: "Tỉ lệ hoàn thành" },
        { key: "Đề nghị Thanh toán", label: "Đề nghị Thanh toán" },
        { key: "Tỉ lệ thanh lý", label: "Tỉ lệ thanh lý" },
        { key: "Đã nộp hồ sơ in (2 dấu) lưu tại Viện", label: "Hồ sơ lưu Viện" },
        { key: "ID", label: "ID" },
        { key: "Year", label: "Year" }
      ],
      tableCols: [
        { key: "Ngày", label: "Ngày", width: "1fr" },
        { key: "Đơn vị thực hiện", label: "Đơn vị thực hiện", width: "1.2fr" },
        { key: "Số Hợp đồng", label: "Số HĐ", width: "1fr" },
        { key: "Tên Hợp đồng", label: "Tên HĐ", width: "1.6fr" },
        { key: "Tình hình thực hiện", label: "Tình hình", width: "1.6fr" },
        { key: "Đánh giá tỉ lệ hoàn thành công việc", label: "Tỉ lệ hoàn thành", width: "1fr" },
        { key: "Đề nghị Thanh toán", label: "Thanh toán", width: "1fr" },
        { key: "Tỉ lệ thanh lý", label: "Tỉ lệ thanh lý", width: "1fr" },
        { key: "Đã nộp hồ sơ in (2 dấu) lưu tại Viện", label: "Hồ sơ lưu Viện", width: "1.2fr" },
        { key: "ID", label: "ID", width: "0.8fr" },
        { key: "Year", label: "Year", width: "0.8fr" }
      ]
    },
    TONG_CONG: {
      label: "Tổng cộng",
      sheet: "TONG_CONG",
      filters: [{ key: "Year", label: "Year" }],
      tableCols: [
        { key: "Year", label: "Year", width: "1fr" },
        { key: "QLKT_Count", label: "QLKT", width: "1fr" },
        { key: "TRINH_VB_Count", label: "Trình VB", width: "1fr" },
        { key: "NGHIEM_THU_NB_Count", label: "Nghiệm thu NB", width: "1fr" },
        { key: "TOTAL_Count", label: "Tổng", width: "1fr" }
      ]
    }
  };

  // ====== FETCH GViz ======
  async function fetchSheetJSON(sheetName) {
    const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
    const res = await fetch(url);
    const raw = await res.text();
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const start = raw.indexOf('{'), end = raw.lastIndexOf('}');
    if (start === -1 || end === -1) throw new Error('Phản hồi không hợp lệ');
    return JSON.parse(raw.substring(start, end + 1));
  }

  // ====== PARSE GViz TABLE ======
  function parseTable(gvizJson) {
    const cols = (gvizJson.table?.cols || []).map(c => c.label || c.id);
    const rows = gvizJson.table?.rows || [];
    return rows.map(r => {
      const obj = {};
      (r.c || []).forEach((cell, idx) => {
        let val = null;
        if (!cell) {
          val = null;
        } else if (cell.v !== undefined) {
          val = cell.v;
          // Nếu là Date object, kiểm tra năm hợp lệ
          if (val instanceof Date) {
            const y = val.getFullYear();
            if (y < 1900 || y > 2100) {
              val = null;
            }
          }
        } else if (cell.f !== undefined) {
          val = cell.f;
        } else {
          val = null;
        }
        obj[cols[idx] || `col${idx}`] = val;
      });
      return obj;
    });
  }

  // ====== NGÀY/THÁNG/NĂM ======
  function parseDateString(s) {
    if (s === null || s === undefined) return null;
    if (s instanceof Date) {
      const y = s.getFullYear();
      if (y < 1900 || y > 2100) return null;
      return { day: s.getDate(), month: s.getMonth() + 1, year: y };
    }
    const str = String(s).trim();
    // GViz: Date(YYYY,MM,DD)
    let m = str.match(/Date\((\d{4}),\s*(\d{1,2}),\s*(\d{1,2})\)/);
    if (m) {
      const year = +m[1], month = +m[2] + 1, day = +m[3];
      if (year < 1900 || year > 2100) return null;
      return { year, month, day };
    }
    m = str.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})$/); if (m) return { day:+m[1], month:+m[2], year:+m[3] };
    m = str.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/); if (m) return { year:+m[1], month:+m[2], day:+m[3] };
    m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/); if (m) return { month:+m[1], day:+m[2], year:+m[3] };

    // Số serial Excel/Google
    if (!isNaN(Number(str))) {
      const serial = Number(str);
      // only convert reasonable serials (avoid tiny numbers that map to 1899)
      if (serial > 59) {
        const date = new Date(Math.round((serial - 25569) * 86400 * 1000));
        const y = date.getUTCFullYear();
        if (y < 1900 || y > 2100) return null;
        return { day: date.getUTCDate(), month: date.getUTCMonth() + 1, year: y };
      } else {
        return null;
      }
    }
    return null;
  }

  function getMonth(row) {
    const keys = ["Ngày", "Ngay", "Date", "date", "Ngày ký", "Ngày nghiệm thu", "Ngay ky", "Ngay nghiem thu"];
    for (const k of keys) {
      if (row[k] !== undefined && row[k] !== null && String(row[k]).trim() !== "") {
        const d = parseDateString(row[k]);
        if (d?.month >= 1 && d.month <= 12) return d.month;
      }
    }
    if (row.Month) {
      const m = Number(row.Month);
      if (!isNaN(m) && m >= 1 && m <= 12) return m;
    }
    return null;
  }

  function getYear(row) {
    const yearKeys = ["Year", "Năm", "Nam", "year", "YEAR"];
    for (const k of yearKeys) {
      if (row[k] !== undefined && row[k] !== null && String(row[k]).trim() !== "") {
        const y = Number(row[k]);
        if (!isNaN(y) && y >= 1900 && y <= 2100) return y;
      }
    }
    const dateKeys = ["Ngày", "Ngay", "Date", "date", "Ngày ký", "Ngày nghiệm thu"];
    for (const k of dateKeys) {
      if (row[k] !== undefined && row[k] !== null && String(row[k]).trim() !== "") {
        const d = parseDateString(row[k]);
        if (d?.year) return d.year;
      }
    }
    return null;
  }

  // ====== Kiểm tra hàng có dữ liệu thực sự ======
  function rowHasMeaningfulData(row) {
    // Consider a row meaningful if at least one cell has non-empty value (not whitespace)
    // and not an obviously invalid year (1899 etc).
    for (const v of Object.values(row)) {
      if (v === null || v === undefined) continue;
      const s = String(v).trim();
      if (s === "") continue;
      // exclude common invalid year artifact
      if (s === "1899" || s === "1899-12-31") continue;
      return true;
    }
    return false;
  }

  // ====== DYNAMIC FILTERS ======
  function buildDynamicFilters(schema, data) {
    dynamicFilters.innerHTML = "";
    if (!schema || !schema.filters) return;
    schema.filters.forEach(f => {
      if (f.key === "Year") return;
      const group = document.createElement("div");
      group.className = "filter-group";
      const label = document.createElement("span");
      label.textContent = f.label;
      const wrapper = document.createElement("div");
      wrapper.className = "filter-wrapper";

      const select = document.createElement("select");
      select.className = "filter-select";
      select.dataset.key = f.key;
      select.innerHTML = `<option value="all">Tất cả</option>`;

      const values = new Set();
      data.forEach(row => {
        const val = row[f.key];
        if (val !== null && val !== undefined && String(val).trim() !== "") values.add(String(val));
      });
      Array.from(values).sort().forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        select.appendChild(opt);
      });

      wrapper.appendChild(select);
      const icon = document.createElement("i");
      icon.className = "fa-solid fa-chevron-down";
      wrapper.appendChild(icon);
      select.addEventListener("change", () => {
        updateDashboard();
        populateBreakdownOptions();
      });

      group.appendChild(label);
      group.appendChild(wrapper);
      dynamicFilters.appendChild(group);
    });
  }

  // ====== APPLY FILTERS ======
  function applyFiltersToData(data, schema) {
    const year = yearFilter.value;
    const month = monthFilter.value;

    let filtered = data.filter(r => {
      const y = getYear(r);
      const m = getMonth(r);
      if (year !== "all" && String(y) !== String(year)) return false;
      if (month !== "all" && String(m) !== String(month)) return false;
      return true;
    });

    dynamicFilters.querySelectorAll(".filter-select").forEach(el => {
      const key = el.dataset.key;
      const val = el.value;
      if (!key) return;
      if (val !== "all") filtered = filtered.filter(r => {
        if (!(key in r)) return true;
        return String(r[key]) === String(val);
      });
    });

    return filtered;
  }

  function rowPassesDynamicFilters(row) {
    const controls = dynamicFilters.querySelectorAll(".filter-select");
    for (const el of controls) {
      const key = el.dataset.key;
      const val = el.value;
      if (!key || val === "all") continue;
      if (!(key in row)) continue;
      if (String(row[key]) !== String(val)) return false;
    }
    return true;
  }

  // ====== KPI ======
  function renderKPIData(filtered) {
    // Tổng số bản ghi: chỉ tính những hàng có dữ liệu thực sự
    const total = filtered.filter(r => rowHasMeaningfulData(r)).length;

    const percentKeys = ["Đánh giá tỉ lệ hoàn thành công việc", "Tỉ lệ hoàn thành"];
    let avgProgress = 0;
    for (const k of percentKeys) {
      const nums = filtered.map(r => Number(String(r[k] ?? "").replace(/[^\d.]/g, ""))).filter(n => !isNaN(n));
      if (nums.length) { avgProgress = Math.round(nums.reduce((s, n) => s + n, 0) / nums.length); break; }
    }
    kpiGrid.innerHTML = `
      <div class="kpi-card">
        <div class="kpi-label">Tổng số bản ghi</div>
        <div class="kpi-value-row">
          <div class="kpi-value">${total}</div>
          <div class="kpi-chip positive"><i class="fa-solid fa-arrow-trend-up"></i> Live</div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Tỉ lệ hoàn thành TB</div>
        <div class="kpi-value-row">
          <div class="kpi-value">${avgProgress}%</div>
          <div class="kpi-chip"><i class="fa-solid fa-clipboard-check"></i> Progress</div>
        </div>
        <div class="progress-bar"><div class="progress-inner" style="width:${avgProgress}%;"></div></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Năm đang lọc</div>
        <div class="kpi-value-row">
          <div class="kpi-value">${yearFilter.value === "all" ? "Tất cả" : yearFilter.value}</div>
          <div class="kpi-chip warning"><i class="fa-solid fa-filter"></i> Scope</div>
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Loại dữ liệu</div>
        <div class="kpi-value-row">
          <div class="kpi-value">${TYPE_SCHEMAS[dataTypeFilter.value].label}</div>
          <div class="kpi-chip"><i class="fa-solid fa-database"></i> Sheet</div>
        </div>
      </div>
    `;
  }

  // ====== MONTH CHART ======
  function renderChart(filtered) {
    const months = Array.from({ length: 12 }, (_, i) => i + 1);

    let dataSourceForChart;
    if (totalMonthlyToggle.checked) {
      const all = [...dataQLKT, ...dataTRINH_VB, ...dataNGHIEM_THU_NB];
      dataSourceForChart = all.filter(r => {
        const y = getYear(r), m = getMonth(r);
        if (yearFilter.value !== "all" && String(y) !== String(yearFilter.value)) return false;
        if (monthFilter.value !== "all" && String(m) !== String(monthFilter.value)) return false;
        return rowPassesDynamicFilters(r);
      });
    } else {
      dataSourceForChart = filtered;
    }

    const data = months.map(m => dataSourceForChart.filter(r => getMonth(r) === m && rowHasMeaningfulData(r)).length);

    const ctx = document.getElementById("monthChart").getContext("2d");
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: months.map(m => m.toString().padStart(2, "0")),
        datasets: [{
          label: `Bản ghi theo tháng ${yearFilter.value === "all" ? "(tất cả năm)" : "năm " + yearFilter.value}${totalMonthlyToggle.checked ? " - tổng cộng" : ""}`,
          data,
          backgroundColor: "rgba(56, 189, 248, 0.7)",
          borderRadius: 4,
          barPercentage: 0.65,
          categoryPercentage: 0.5
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `Số lượng: ${ctx.parsed.y}` } } },
        scales: {
          x: { grid: { display: false }, ticks: { color: "#9ca3af", font: { size: 11 } } },
          y: { beginAtZero: true, grid: { color: "rgba(55, 65, 81, 0.6)" }, ticks: { color: "#9ca3af", stepSize: 1, font: { size: 11 } } }
        }
      }
    });
  }

  // ====== PIE THEO LOẠI ======
  function renderPieChart() {
    const filterWithAllControls = ds => ds.filter(r => {
      const y = getYear(r), m = getMonth(r);
      if (yearFilter.value !== "all" && String(y) !== String(yearFilter.value)) return false;
      if (monthFilter.value !== "all" && String(m) !== String(monthFilter.value)) return false;
      return rowPassesDynamicFilters(r);
    });

    const qlktCount = filterWithAllControls(dataQLKT).filter(r => rowHasMeaningfulData(r)).length;
    const trinhvbCount = filterWithAllControls(dataTRINH_VB).filter(r => rowHasMeaningfulData(r)).length;
    const nghiemthuCount = filterWithAllControls(dataNGHIEM_THU_NB).filter(r => rowHasMeaningfulData(r)).length;

    const ctx = document.getElementById("pieChart").getContext("2d");
    if (pie) pie.destroy();
    pie = new Chart(ctx, {
      type: "pie",
      data: {
        labels: ["QLKT", "Trình VB", "Nghiệm thu NB"],
        datasets: [{
          data: [qlktCount, trinhvbCount, nghiemthuCount],
          backgroundColor: ["#60a5fa", "#34d399", "#fbbf24"],
          borderColor: ["#1f2937", "#1f2937", "#1f2937"],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "bottom", labels: { color: "#9ca3af", boxWidth: 12 } },
          tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.parsed}` } }
        }
      }
    });
  }

  // ====== BREAKDOWN PIE ======
  function populateBreakdownOptions() {
    const candidateFields = [
      "Chuyên viên phụ trách", "Đơn vị thực hiện", "Chủ nhiệm", "Mục đích trình",
      "Lãnh đạo ký", "Nhân viên soạn thảo văn bản", "Nhân viên soạn thảo",
      "Đánh giá tỉ lệ hoàn thành công việc", "Tỉ lệ hoàn thành",
      "Đề nghị Thanh toán", "Đã nộp hồ sơ in (2 dấu) lưu tại Viện", "Hồ sơ lưu Viện"
    ];

    let sourceData;
    if (dataTypeFilter.value === "QLKT") sourceData = dataQLKT;
    else if (dataTypeFilter.value === "TRINH_VB") sourceData = dataTRINH_VB;
    else if (dataTypeFilter.value === "NGHIEM_THU_NB") sourceData = dataNGHIEM_THU_NB;
    else sourceData = [...dataQLKT, ...dataTRINH_VB, ...dataNGHIEM_THU_NB];

    const available = candidateFields.filter(f => sourceData.some(r => r[f] !== undefined && r[f] !== null && String(r[f]).trim() !== ""));
    const dynamicKeys = [];
    const schema = TYPE_SCHEMAS[dataTypeFilter.value];
    if (schema && schema.filters) {
      schema.filters.forEach(f => { if (f.key !== "Year" && !available.includes(f.key)) dynamicKeys.push(f.key); });
    }
    dynamicKeys.forEach(k => { if (!available.includes(k)) available.push(k); });

    breakdownField.innerHTML = `<option value="none">Chọn trường để phân tích</option>` +
      available.map(k => `<option value="${encodeURIComponent(k)}">${k}</option>`).join("");

    const prev = breakdownField.dataset.selected;
    if (prev && available.includes(prev)) {
      breakdownField.value = encodeURIComponent(prev);
    } else {
      breakdownField.value = "none";
      breakdownField.dataset.selected = "";
      if (breakdownChart) { breakdownChart.destroy(); breakdownChart = null; }
      document.getElementById("breakdownPie").getContext("2d").clearRect(0,0,1,1);
    }
  }

  function renderBreakdownPie(fieldKeyEncoded) {
    if (!fieldKeyEncoded || fieldKeyEncoded === "none") {
      if (breakdownChart) { breakdownChart.destroy(); breakdownChart = null; }
      return;
    }
    const fieldKey = decodeURIComponent(fieldKeyEncoded);
    breakdownField.dataset.selected = fieldKey;

    let sourceData;
    if (dataTypeFilter.value === "QLKT") sourceData = dataQLKT;
    else if (dataTypeFilter.value === "TRINH_VB") sourceData = dataTRINH_VB;
    else if (dataTypeFilter.value === "NGHIEM_THU_NB") sourceData = dataNGHIEM_THU_NB;
    else sourceData = [...dataQLKT, ...dataTRINH_VB, ...dataNGHIEM_THU_NB];

    const filtered = applyFiltersToData(sourceData, TYPE_SCHEMAS[dataTypeFilter.value]).filter(r => rowHasMeaningfulData(r));

    const counts = new Map();
    filtered.forEach(r => {
      let v = (fieldKey in r) ? r[fieldKey] : null;
      if (v === null || v === undefined || String(v).trim() === "") v = "(Trống)";
      const key = String(v);
      counts.set(key, (counts.get(key) || 0) + 1);
    });

    if (counts.size === 0) {
      if (breakdownChart) { breakdownChart.destroy(); breakdownChart = null; }
      document.getElementById("breakdownPie").getContext("2d").clearRect(0,0,1,1);
      return;
    }

    const items = Array.from(counts.entries()).sort((a,b)=>b[1]-a[1]);
    const top = items.slice(0, 10);
    const others = items.slice(10);
    const labels = top.map(i => i[0]);
    const data = top.map(i => i[1]);
    if (others.length) {
      labels.push("Khác");
      data.push(others.reduce((s,i)=>s+i[1],0));
    }

    const colors = [
      "#60a5fa","#34d399","#fbbf24","#f87171","#a78bfa","#fb7185","#60a5fa","#34d399","#fbbf24","#f97316","#94a3b8"
    ];

    const ctx = document.getElementById("breakdownPie").getContext("2d");
    if (breakdownChart) breakdownChart.destroy();
    breakdownChart = new Chart(ctx, {
      type: "pie",
      data: {
        labels,
        datasets: [{ data, backgroundColor: colors.slice(0, labels.length), borderColor: "#1f2937", borderWidth: 1 }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "bottom", labels: { color: "#9ca3af", boxWidth: 12 } },
          tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.parsed}` } }
        }
      }
    });
  }

  // ====== TABLE ======
  function renderTable(schema, filtered) {
    if (dataTypeFilter.value === "TONG_CONG") {
      const yearCounts = aggregateYearCounts();
      const filteredYears = yearFilter.value === "all"
        ? yearCounts
        : yearCounts.filter(y => String(y.Year) === String(yearFilter.value));

      const cols = TYPE_SCHEMAS.TONG_CONG.tableCols;
      const colTemplate = cols.map(c => c.width || "1fr").join(" ");
      tableHeader.style.setProperty("--cols", colTemplate);
      tableBody.style.setProperty("--cols", colTemplate);
      tableHeader.innerHTML = cols.map(c => `<div>${c.label}</div>`).join("");

      const rowsHtml = filteredYears.map(r => `
        <div class="table-row">
          <div>${safe(r.Year)}</div>
          <div>${safe(r.QLKT_Count)}</div>
          <div>${safe(r.TRINH_VB_Count)}</div>
          <div>${safe(r.NGHIEM_THU_NB_Count)}</div>
          <div>${safe(r.TOTAL_Count)}</div>
        </div>
      `).join("");

      tableBody.innerHTML = rowsHtml || `<div style="padding:10px;color:var(--muted);">Không có dữ liệu tổng hợp cho năm đã chọn.</div>`;
      return;
    }

    const cols = schema.tableCols;
    const colTemplate = cols.map(c => c.width || "1fr").join(" ");
    tableHeader.style.setProperty("--cols", colTemplate);
    tableBody.style.setProperty("--cols", colTemplate);
    tableHeader.innerHTML = cols.map(c => `<div>${c.label}</div>`).join("");

    const rowsHtml = filtered.filter(r => rowHasMeaningfulData(r)).slice(0, 100).map(r => {
      return `<div class="table-row">${cols.map(c => `<div>${safe(r[c.key])}</div>`).join("")}</div>`;
    }).join("");

    tableBody.innerHTML = rowsHtml || `<div style="padding:10px;color:var(--muted);">Không có bản ghi phù hợp.</div>`;
  }
  function safe(v) { return (v === null || v === undefined) ? "" : String(v); }

  // ====== AGGREGATE ======
  function aggregateYearCounts() {
    const allYears = new Map();
    const add = (year, key) => {
      if (!year) return;
      if (!allYears.has(year)) allYears.set(year, { Year: year, QLKT_Count: 0, TRINH_VB_Count: 0, NGHIEM_THU_NB_Count: 0, TOTAL_Count: 0 });
      const o = allYears.get(year);
      o[key] += 1;
      o.TOTAL_Count += 1;
    };
    dataQLKT.forEach(r => {
      const y = getYear(r);
      if (!y) {
        if (rowHasMeaningfulData(r)) console.warn("QLKT row missing valid year:", r);
      } else add(y, "QLKT_Count");
    });
    dataTRINH_VB.forEach(r => {
      const y = getYear(r);
      if (!y) {
        if (rowHasMeaningfulData(r)) console.warn("TRINH_VB row missing valid year:", r);
      } else add(y, "TRINH_VB_Count");
    });
    dataNGHIEM_THU_NB.forEach(r => {
      const y = getYear(r);
      if (!y) {
        if (rowHasMeaningfulData(r)) console.warn("NGHIEM_THU_NB row missing valid year:", r);
      } else add(y, "NGHIEM_THU_NB_Count");
    });
    return Array.from(allYears.values()).sort((a,b) => Number(b.Year) - Number(a.Year));
  }

  // ====== POPULATE YEAR ======
  function populateYearFilter() {
    const years = new Set();
    [dataQLKT, dataTRINH_VB, dataNGHIEM_THU_NB].forEach(ds => {
      ds.forEach(r => {
        const y = getYear(r);
        if (y) years.add(String(y));
      });
    });
    const arr = Array.from(years).map(Number).filter(n => !isNaN(n)).sort((a,b)=>a-b);
    yearFilter.innerHTML = `<option value="all">Tất cả</option>` + arr.map(y => `<option value="${y}">${y}</option>`).join("");
  }

  // ====== UPDATE DASHBOARD ======
  function updateDashboard() {
    errorBox.style.display = "none";
    loadingKpi.style.display = "none";

    const schema = TYPE_SCHEMAS[dataTypeFilter.value];
    let sourceData;
    if (dataTypeFilter.value === "QLKT") sourceData = dataQLKT;
    else if (dataTypeFilter.value === "TRINH_VB") sourceData = dataTRINH_VB;
    else if (dataTypeFilter.value === "NGHIEM_THU_NB") sourceData = dataNGHIEM_THU_NB;
    else sourceData = [...dataQLKT, ...dataTRINH_VB, ...dataNGHIEM_THU_NB];

    buildDynamicFilters(schema, sourceData);

    const filtered = applyFiltersToData(sourceData, schema);

    renderKPIData(filtered);
    renderChart(filtered);
    renderPieChart();
    renderTable(schema, filtered);

    if (dataTypeFilter.value === "QLKT") {
      footerText.textContent = "Dữ liệu QLKT.";
      cardFooter.style.display = "flex";
    } else {
      cardFooter.style.display = "none";
    }

    populateBreakdownOptions();
    const sel = breakdownField.value || "none";
    renderBreakdownPie(sel);
  }

  // ====== LOAD DATA ======
  async function loadAllDataAndInit() {
    try {
      loadingKpi.style.display = "block";
      const [g1, g2, g3] = await Promise.all([
        fetchSheetJSON(SHEET_NAME_DUAN),
        fetchSheetJSON(SHEET_NAME_TRINHKY),
        fetchSheetJSON(SHEET_NAME_NGHIEMTHU)
      ]);
      dataQLKT = parseTable(g1);
      dataTRINH_VB = parseTable(g2);
      dataNGHIEM_THU_NB = parseTable(g3);

      populateYearFilter();
      updateDashboard();
    } catch (err) {
      loadingKpi.style.display = "none";
      errorBox.style.display = "block";
      errorBox.textContent = "Lỗi khi tải dữ liệu: " + err.message;
      console.error(err);
    }
  }

  // ====== EVENTS ======
  document.addEventListener("DOMContentLoaded", () => {
    loadAllDataAndInit();
    dataTypeFilter.addEventListener("change", updateDashboard);
    yearFilter.addEventListener("change", updateDashboard);
    monthFilter.addEventListener("change", updateDashboard);
    totalMonthlyToggle.addEventListener("change", updateDashboard);
    breakdownField.addEventListener("change", (e) => renderBreakdownPie(e.target.value));
  });
</script>
</body>
</html>
